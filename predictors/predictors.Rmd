---
title: "R Notebook"
---

# Load packages
```{r}
library(terra)
library(dplyr)
library(corrplot)
library(usdm)
if(!dir.exists("_predictor_stack")){dir.create("_predictor_stack", recursive = TRUE)}
if(!dir.exists("_predictor_stack_vif")){dir.create("_predictor_stack_vif", recursive = TRUE)}
```

# Clear existing rasters incase of errors
# WARNING: this will delete the previously exported predictors
```{r}
l <- list.files("_predictor_stack", full.names = TRUE)
file.remove(l)

l <- list.files("_predictor_stack_vif", full.names = TRUE)
file.remove(l)
```

# Save predictor list
```{r}
l <- list.dirs("process", full.names = TRUE, recursive = TRUE)
l <- l[basename(l) == "outputs"]
l <- list.files(l, pattern = "\\.tif$", full.names = TRUE)
n <- tools::file_path_sans_ext(basename(l))

df <- data.frame(predictor = n[order(n)])
write.csv(df, "predictor_list.csv", row.names = FALSE) # Careful not to overwrite if metadata has been filled in
```

# Explore correlations between predictors
```{r}
l <- list.dirs("process", full.names = TRUE, recursive = TRUE)
l <- l[basename(l) == "outputs"]
l <- l[l != "process/substrate/outputs"] # Exclude categorical predictors
l <- list.files(l, pattern = "\\.tif$", full.names = TRUE)
#l <- l[!grepl("_sd_", l, fixed = TRUE)] # Exclude SD layers?
n <- tools::file_path_sans_ext(basename(l))

preds <- rast(l)
names(preds) <- n
samp <- spatSample(preds, size = 100000, na.rm = TRUE, as.df = TRUE)
m <- cor(samp)

# Export image
jpeg(filename = "correlation_plot_with_SDs.jpg", width=3000, height=3000, res=150)
corrplot(m, method = "circle", order = "AOE", diag = FALSE)
dev.off()

l <- list.dirs("process", full.names = TRUE, recursive = TRUE)
l <- l[basename(l) == "outputs"]
l <- l[l != "process/substrate/outputs"] # Exclude categorical predictors
l <- list.files(l, pattern = "\\.tif$", full.names = TRUE)
l <- l[!grepl("_sd_", l, fixed = TRUE)] # Exclude SD layers?
n <- tools::file_path_sans_ext(basename(l))

preds <- rast(l)
names(preds) <- n
samp <- spatSample(preds, size = 100000, na.rm = TRUE, as.df = TRUE)
m <- cor(samp)

# Export image
jpeg(filename = "correlation_plot_without_SDs.jpg", width=3000, height=3000, res=150)
corrplot(m, method = "circle", order = "AOE", diag = FALSE)
dev.off()
```

# Test for multicollinearity
```{r}
l <- list.dirs("process", full.names = TRUE, recursive = TRUE)
l <- l[basename(l) == "outputs"]
l <- l[l != "process/substrate/outputs"] # Exclude categorical predictors
l <- list.files(l, pattern = "\\.tif$", full.names = TRUE)
#l <- l[!grepl("_sd_", l, fixed = TRUE)] # Exclude SD layers?
n <- tools::file_path_sans_ext(basename(l))

preds <- rast(l)
names(preds) <- n
samp <- spatSample(preds, size = 100000, na.rm = TRUE, as.df = TRUE)
vifs <- vif(samp)
viftest <- vifstep(samp, th = 10)
viftest@excluded
```

# Save VIF results
```{r}
df$vif_test_include <- "exclude"
df$vif_test_include[df$predictor %in% viftest@results$Variables] <- "include"
df <- left_join(df, vifs, by = join_by(predictor == Variables))
vif_keep <- viftest@results
colnames(vif_keep) <- c("predictor", "vif_test_10")
df <- left_join(df, vif_keep, by = join_by(predictor == predictor))
write.csv(df, "vif_test.csv", row.names = FALSE)
```

# Write full stack to single TIF file
```{r}
l <- list.dirs("process", full.names = TRUE, recursive = TRUE)
l <- l[basename(l) == "outputs"]
l <- list.files(l, pattern = "\\.tif$", full.names = TRUE)
n <- tools::file_path_sans_ext(basename(l))
preds <- rast(l)
names(preds) <- n

writeRaster(preds, "predictor_stack.tif", overwrite = TRUE, 
            gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Save individual predictor layers in single folder
```{r}
l <- list.dirs("process", full.names = TRUE, recursive = TRUE)
l <- l[basename(l) == "outputs"]
l <- list.files(l, pattern = "\\.tif$", full.names = TRUE)
n <- tools::file_path_sans_ext(basename(l))
preds <- rast(l)
names(preds) <- n

for(i in 1:nlyr(preds)){
  writeRaster(preds[[i]], paste0("_predictor_stack/", names(preds)[i], ".tif"), 
              overwrite = TRUE, gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}
```

