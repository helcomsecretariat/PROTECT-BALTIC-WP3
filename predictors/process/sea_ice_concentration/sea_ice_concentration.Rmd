---
title: "R Notebook"
---
# Load packages/functions/data
```{r, include = FALSE}
library(terra)
library(lubridate)
grid <- rast("../../../grid/outputs/grid_marine_250m.tif")
if(!dir.exists("inputs/temp")){dir.create("inputs/temp", recursive = TRUE)}
if(!dir.exists("inputs/monthly_means")){dir.create("inputs/monthly_means")}
if(!dir.exists("outputs")){dir.create("outputs")}
source("../../_functions/resint.R") # Script for resampling
exnon <- FALSE # Export non-resampled rasters?

# Download Copernicus data with python script
# NOTE: Check cop_pull.py to ensure it is pulling relevant data 
reticulate::source_python("cop_pull.py")
```

# Calculate monthly means
# NOTE na.rm = TRUE due to some months and cells containing no data
```{r}
l <- list.files("inputs/temp", full.names = TRUE)

yrs <- 2010:2023
for(i in 1:length(yrs)){

  yr <- yrs[i]
  
  for(j in 1:12){
    first_day <- 1
    d <- ymd(paste(yr, j, first_day, sep = "-"))
    last_day <- as.vector(days_in_month(d))
    first_day <- yday(d)
    last_day <- yday(ymd(paste(yr, j, last_day, sep = "-")))
    
    r <- rast(l[i])
    r <- r[[first_day:last_day]]
    
    r <- app(r, fun = "mean", na.rm = TRUE)
    names(r) <- paste0("month", j)
    if(j == 1){rst <- r}
    if(j > 1){rst <- c(rst, r)}
    
  }
  
  writeRaster(rst, paste0("inputs/monthly_means/sea_ice_concentration_monthly_", yr, ".tif"), overwrite = TRUE)
  cat("Year", yr, "complete - ")
}
```

# Sea ice concentration mean
```{r}
l <- list.files("inputs/monthly_means", full.names = TRUE)

for(i in 1:length(l)){
  r <- rast(l[i])
  r <- app(r, fun = "mean", na.rm = TRUE)
  if(i == 1){rst <- r}
  if(i > 1){rst <- c(rst, r)}
}

temp <- app(rst, fun = "mean", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/sea_ice_concentration_mean_250m.tif", overwrite = TRUE, 
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "mean", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
temp_res[temp_res < 0] <- 0 # Fix bad cubic interpolations (negative ice concentration)
writeRaster(temp_res, "outputs/sea_ice_concentration_mean_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Sea ice concentration coefficient of variation
```{r}
cv <- function(i) (sd(i, na.rm = TRUE)/mean(i, na.rm = TRUE))*100 # Coefficient of variation function

l <- list.files("inputs/monthly_means", full.names = TRUE)

for(i in 1:length(l)){
  r <- rast(l[i])
  r <- app(r, fun = cv)
  if(i == 1){rst <- r}
  if(i > 1){rst <- c(rst, r)}
}

temp <- app(rst, fun = "mean", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/sea_ice_concentration_cv_250m.tif", overwrite = TRUE,
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "mean", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
temp_res[temp_res < 0] <- 0 # Fix bad cubic interpolations giving slight negative SDs (impossible)
writeRaster(temp_res, "outputs/sea_ice_concentration_cv_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```


***************************

```{r}
yrs <- 2010:2023

for(i in 1:length(yrs)){
  yr <- yrs[i]
  l <- list.files(paste0("inputs/temp/", yr), full.names = TRUE)
  r <- rast(l)
  r <- app(r, fun = "mean", na.rm = TRUE) # Since ice is not present year round, na.rm = TRUE
  names(r) <- yr
  if(i == 1){rst <- r}
  if(i > 1){rst <- c(rst, r)}
}
```


# Sea ice concentration mean
```{r}
l <- list.files("inputs/temp", full.names = TRUE)

for(i in 1:length(l)){
  r <- rast(l[i])
  n <- names(r)
  n <- n[grepl("ice_concentration_", n, fixed = TRUE)]
  r <- r[[n]]
  r <- app(r, fun = "mean") # Since ice is not present year round, na.rm = TRUE
  if(i == 1){rst <- r}
  if(i > 1){rst <- c(rst, r)}
}

temp <- app(rst, fun = "mean", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/sea_ice_concentration_mean_250m.tif", overwrite = TRUE, 
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "mean", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
writeRaster(temp_res, "outputs/sea_ice_concentration_mean_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Sea ice concentration coefficient of variation
```{r}
cv <- function(i) (sd(i, na.rm = TRUE)/mean(i, na.rm = TRUE))*100 # Coefficient of variation function

l <- list.files("inputs/temp", full.names = TRUE)

for(i in 1:length(l)){
  r <- rast(l[i])
  n <- names(r)
  n <- n[grepl("ice_concentration_", n, fixed = TRUE)]
  r <- r[[n]]
  r <- app(r, fun = cv)
  if(i == 1){rst <- r}
  if(i > 1){rst <- c(rst, r)}
}

temp <- app(rst, fun = "mean", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/sea_ice_concentration_cv_250m.tif", overwrite = TRUE,
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "mean", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
temp_res[temp_res < 0] <- 0 # Fix bad cubic interpolations giving slight negative SDs (impossible)
writeRaster(temp_res, "outputs/sea_ice_concentration_cv_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Remove netCDF files from disk
```{r}
l <- list.files("inputs/temp", full.names = TRUE)
file.remove(l) 
```

