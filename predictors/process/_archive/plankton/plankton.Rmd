---
title: "R Notebook"
---
# NOTE: Run cop_pull.py first to pull data from Copernicus

# Load packages/functions
```{r}
library(terra)
grid <- rast("../../../grid/outputs/grid_250m.tif")
if(!dir.exists("inputs/temp")){dir.create("inputs/temp", recursive = TRUE)}
if(!dir.exists("outputs")){dir.create("outputs")}
source("../../_functions/resint.R") # Script for resampling
exnon <- TRUE # Export non-resampled rasters?
```

# Chlorophyll-a mean
```{r}
l <- list.files("inputs/temp", full.names = TRUE)

for(i in 1:length(l)){
  r <- rast(l[i])
  n <- names(r)
  n <- n[grepl("CHL_", n, fixed = TRUE)]
  r <- r[[n]]
  r <- app(r, fun = "mean", na.rm = TRUE)
  if(i == 1){rst <- r}
  if(i > 1){rst <- c(rst, r)}
}

temp <- app(rst, fun = "mean", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/chloro_a_reflect_mean_250m.tif", overwrite = TRUE, 
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "mean", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
writeRaster(temp_res, "outputs/chloro_a_reflect_mean_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Chlorophyll-a standard deviation
```{r}
temp <- app(rst, fun = "sd", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/chloro_a_reflect_sd_250m.tif", overwrite = TRUE,
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "sd", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
writeRaster(temp_res, "outputs/chloro_a_reflect_sd_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Microphytoplankton mean
```{r}
l <- list.files("inputs/temp", full.names = TRUE)

for(i in 1:length(l)){
  r <- rast(l[i])
  n <- names(r)
  n <- n[grepl("MICRO_", n, fixed = TRUE)]
  r <- r[[n]]
  r <- app(r, fun = "mean", na.rm = TRUE)
  if(i == 1){rst <- r}
  if(i > 1){rst <- c(rst, r)}
}

temp <- app(rst, fun = "mean", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/microphytoplankton_reflect_mean_250m.tif", overwrite = TRUE,
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "mean", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
writeRaster(temp_res, "outputs/microphytoplankton_reflect_mean_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Microphytoplankton standard deviation
```{r}
temp <- app(rst, fun = "sd", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/microphytoplankton_reflect_sd_250m.tif", overwrite = TRUE,
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "sd", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
writeRaster(temp_res, "outputs/microphytoplankton_reflect_sd_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Nanophytoplankton mean
```{r}
l <- list.files("inputs/temp", full.names = TRUE)

for(i in 1:length(l)){
  r <- rast(l[i])
  n <- names(r)
  n <- n[grepl("NANO_", n, fixed = TRUE)]
  r <- r[[n]]
  r <- app(r, fun = "mean", na.rm = TRUE)
  if(i == 1){rst <- r}
  if(i > 1){rst <- c(rst, r)}
}

temp <- app(rst, fun = "mean", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/nanophytoplankton_reflect_mean_250m.tif", overwrite = TRUE, 
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "mean", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
writeRaster(temp_res, "outputs/nanophytoplankton_reflect_mean_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Nanophytoplankton standard deviation
```{r}
temp <- app(rst, fun = "sd", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/nanophytoplankton_reflect_sd_250m.tif", overwrite = TRUE,
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "sd", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
writeRaster(temp_res, "outputs/nanophytoplankton_reflect_sd_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Picophytoplankton mean
```{r}
l <- list.files("inputs/temp", full.names = TRUE)

for(i in 1:length(l)){
  r <- rast(l[i])
  n <- names(r)
  n <- n[grepl("PICO_", n, fixed = TRUE)]
  r <- r[[n]]
  r <- app(r, fun = "mean", na.rm = TRUE)
  if(i == 1){rst <- r}
  if(i > 1){rst <- c(rst, r)}
}

temp <- app(rst, fun = "mean", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/picophytoplankton_reflect_mean_250m.tif", overwrite = TRUE, 
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "mean", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
writeRaster(temp_res, "outputs/picophytoplankton_reflect_mean_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Picophytoplankton standard deviation
```{r}
temp <- app(rst, fun = "sd", na.rm = TRUE)
temp <- project(temp, grid, method = "near")
temp <- temp*grid
if(exnon){
  writeRaster(temp, "outputs/picophytoplankton_reflect_sd_250m.tif", overwrite = TRUE,
              datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
}

# Resample to higher resolution
temp <- app(rst, fun = "sd", na.rm = TRUE)
temp_res <- resint(temp, grid, nit = 50, win_size = 3, method = "cubic")
writeRaster(temp_res, "outputs/picophytoplankton_reflect_sd_resample_250m.tif", overwrite = TRUE, 
            datatype = "FLT4S", gdal=c("COMPRESS=ZSTD", "PREDICTOR=2"))
```

# Remove netCDF files from disk
```{r}
l <- list.files("inputs/temp", full.names = TRUE)
file.remove(l) 
```

**********************

```{r}
l <- list.files("inputs/temp", full.names = TRUE)
r <- rast(l[i])
r <- r[[1]]
n <- names(r)
n <- n[grepl("NANO_", n, fixed = TRUE)]
```

********************
```{r}
library(ncdf4)
temp <- nc_open("inputs/temp/bal_plankton_multi_2010.nc")
x <- ncvar_get(temp, "CHL")
```

